<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<audio id="audio" width="400" height="300" controls autoplay>

</audio>
<button id="button">send</button>
<script src="js/adapter.js"></script>
<script>
    const configuration = {
        "iceServers": [{
            "url": "stun:0x00000000.me:3478"
        }, {"url": "turn:0x00000000.me:3478", "username": "a", "credential": "b"}]
    }

    var socket = new WebSocket("wss://0x00000000.me:9502");
    var sdp;

    function sendSocket(type = "", data) {
        socket.send(JSON.stringify({"type": type, "data": data}));
        // return;
        switch (type) {
            case "description":
                // socket.send(JSON.stringify({"type": type, "data": JSON.stringify(data)}));
                break;
            case "ice-candidate":
                // socket.send(JSON.stringify({"type": type, "data": JSON.stringify(data)}));
                break;
            default:
                console.log("sending socket is fucked");
        }
    }
</script>
<script>


    var localConnection = new RTCPeerConnection(configuration);

    // PeerConnection需要传递一个RTCConfiguration对象作为参数，如果你没有传递参数的话，火狐浏览器会自动提供一个参数
    // var localConnection = new RTCPeerConnection();
    //
    //
    // localConnection.onaddstream = function (obj) {
    //     // console.log("localConnection.onaddstream", obj)
    //     let video_ele = document.getElementById("audio");
    //     video_ele.srcObject = obj.stream;
    //     // localConnection.addStream(obj.stream).catch((error) => console.log(error))
    // }
    //chrome version
    // pc.onaddstream = function(event) {
    //     document.getElementById("received_video").srcObject = event.stream;
    //     document.getElementById("hangup-button").disabled = false;
    // };


    socket.onopen = function () {

        navigator.mediaDevices.getUserMedia({audio: true}).then(function (stream) {
            // console.log("navigator.mediaDevices.getUserMedia")
            // localConnection.onaddstream({stream: stream})
            // Adding a local stream won't trigger the onaddstream callback
            // localConnection.addStream(stream)
            stream.getTracks().forEach(track => localConnection.addTrack(track, stream));
        }).then(() => {
            connectPeers();
        });

        ;
    }

    function connectPeers() {
        // Create the local connection and its event listeners
        // console.log("connectPeers")

        // Create the data channel and establish its event listeners
        const sendChannel = localConnection.createDataChannel("sendChannel");
        const button_ele = document.getElementById("button");
        button_ele.addEventListener("click", () => {
            console.log(sendChannel)
            sendChannel.send("i am data");
        })
        sendChannel.onopen = function () {
            console.log("sendChannel.onopen");
        };
        sendChannel.onclose = (e) => console.log("shit2");

        //push to remote
        localConnection.onicecandidate = function (e) {
            console.log(e.candidate.type);
            sendSocket("ice-candidate", e.candidate);
        };

        localConnection.createOffer()
            .then(offer => {
                localConnection.setLocalDescription(offer);
                sendSocket("description", offer);
            })

        socket.onmessage = function (event) {
            // console.log(event.data);
            let receiveData = JSON.parse(event.data);
            switch (receiveData.type) {
                case "description":
                    goSetDescription(receiveData.data);
                    break;
                case "ice-candidate":
                    goSetIceCandidate(receiveData.data);
                    break;
                default:
                    console.log("receive socket is fucked")
            }
        }
    }

    function goSetDescription(receiveData) {
        // console.log(receiveData);
        sdp = receiveData;
        console.log(sdp);
        localConnection.setRemoteDescription(new RTCSessionDescription(sdp))
            .then(function () {
                // return navigator.mediaDevices.getUserMedia({audio: true});
            })
            .then(function (stream) {
                // previewElement.srcObject = stream;
                // console.log(localConnection.iceConnectionState);
                // stream.getTracks().forEach(track => localConnection.addTrack(track, stream));
            });
    }

    function goSetIceCandidate(candidate) {
        if (candidate) {
            console.log((new RTCIceCandidate(candidate)).type);
        }
        // if (!candidate || (new RTCIceCandidate(candidate)).type != "srflx") {
        //     return;
        // }
        // console.log("fucked")
        !candidate || localConnection.addIceCandidate(candidate).catch((error) => console.log(error));
        // !candidate || localConnection.addIceCandidate(new RTCIceCandidate(candidate)).catch((error) => console.log(error));
    }

</script>
</body>
</html>